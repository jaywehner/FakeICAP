{% extends "base.html" %}

{% block title %}Dashboard - FakeICAP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
    <div>
        <span class="status-indicator status-online"></span>
        <span class="text-muted">Server Online</span>
    </div>
</div>

<!-- Active Connections + Quick Actions + System Info -->
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Active Connections</h5>
            </div>
            <div class="card-body">
                {% if server_status.connections and server_status.connections|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Filename</th>
                                <th class="text-end">Bytes</th>
                                <th class="text-end">Chunks</th>
                                <th class="text-end">Idle (s)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conn in server_status.connections %}
                            <tr>
                                <td>{{ conn.client }}</td>
                                <td>{{ conn.filename }}</td>
                                <td class="text-end">{{ conn.bytes }}</td>
                                <td class="text-end">{{ conn.chunks }}</td>
                                <td class="text-end">{{ conn.age_seconds }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No active connections at this time.</p>
                {% endif %}
            </div>
            <div class="card-footer small text-muted d-flex justify-content-between">
                <span>Active transfers: {{ server_status.active_transfers }}</span>
                <span>Uptime: <span id="uptime-display" data-uptime-seconds="{{ server_status.uptime_seconds }}">{{ server_status.uptime }}</span></span>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                {% set role = session.get('role') or 'FULL_ACCESS' %}
                {% set is_admin = session.get('is_admin') %}
                <div class="d-grid gap-2">
                    {% if is_admin %}
                    <button class="btn btn-outline-primary" onclick="restartServer()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Restart ICAP Server
                    </button>
                    {% endif %}

                    {% if is_admin or role in ['FULL_ACCESS', 'LOG_VIEWER'] %}
                    <a class="btn btn-outline-success" href="{{ url_for('logs') }}">
                        <i class="bi bi-file-text me-2"></i>View Server Logs
                    </a>
                    {% endif %}

                    {% if is_admin or role in ['FULL_ACCESS', 'FILE_DOWNLOAD'] %}
                    <a class="btn btn-outline-secondary" href="{{ url_for('processed_files') }}">
                        <i class="bi bi-folder me-2"></i>View Files
                    </a>
                    {% endif %}

                    <button class="btn btn-outline-info" onclick="testConnection()">
                        <i class="bi bi-wifi me-2"></i>Test Connection
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>System Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Application:</strong> FakeICAP Web Interface
                </div>
                <div class="mb-2">
                    <strong>Version:</strong> 1.0.0
                </div>
                <div class="mb-2">
                    <strong>Python:</strong> 3.9+
                </div>
                <div class="mb-2">
                    <strong>Database:</strong> SQLite
                </div>
                <div class="mb-2">
                    <strong>Framework:</strong> Flask + Bootstrap
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        Last updated: {{ current_time }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Live uptime updater
document.addEventListener('DOMContentLoaded', function() {
    const uptimeEl = document.getElementById('uptime-display');
    if (!uptimeEl) return;

    let totalSeconds = parseInt(uptimeEl.getAttribute('data-uptime-seconds') || '0', 10) || 0;

    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        let rem = seconds % 86400;
        const hours = Math.floor(rem / 3600);
        rem = rem % 3600;
        const minutes = Math.floor(rem / 60);
        const secs = rem % 60;

        const hh = hours.toString().padStart(2, '0');
        const mm = minutes.toString().padStart(2, '0');
        const ss = secs.toString().padStart(2, '0');

        if (days > 0) {
            return `${days}d ${hh}:${mm}:${ss}`;
        }
        return `${hh}:${mm}:${ss}`;
    }

    uptimeEl.textContent = formatUptime(totalSeconds);

    setInterval(function() {
        totalSeconds += 1;
        uptimeEl.textContent = formatUptime(totalSeconds);
    }, 1000);
});

function restartServer() {
    if (!confirm('Are you sure you want to restart the ICAP server?')) {
        return;
    }

    showNotification('Restarting ICAP server...', 'info');

    fetch('/restart_icap', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    }).then(data => {
        if (data && data.status === 'ok') {
            showNotification('ICAP server restarted successfully.', 'success');
        } else {
            const msg = (data && data.message) || 'Unknown error restarting ICAP server.';
            showNotification(msg, 'error');
        }
    }).catch(err => {
        showNotification('Failed to restart ICAP server: ' + err, 'error');
    });
}

function viewLogs() {
    window.location.href = '/logs';
}

function testConnection() {
    showNotification('Testing ICAP server connection...', 'info');
    
    // Simulate connection test
    setTimeout(() => {
        showNotification('Connection test successful!', 'success');
    }, 1500);
}

function showNotification(message, type) {
    if (window.notificationManager) {
        window.notificationManager.show(message, type);
    } else {
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
}

// Apply theme changes immediately (only if the control exists on this page)
const themeSelect = document.getElementById('theme');
if (themeSelect) {
    themeSelect.addEventListener('change', function() {
        document.documentElement.setAttribute('data-bs-theme', this.value);
        localStorage.setItem('theme', this.value);
        const icon = document.getElementById('theme-icon');
        if (icon) {
            icon.className = this.value === 'light' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
        }
    });
}

// Apply accent color changes immediately (only if the control exists on this page)
const accentSelect = document.getElementById('accent_color');
if (accentSelect && window.applyAccentColor) {
    accentSelect.addEventListener('change', function() {
        window.applyAccentColor(this.value);
    });
}
</script>
{% endblock %}
