<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ ui_theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FakeICAP Web Interface{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --bs-primary: #fd7e14;
            --bs-primary-hover: #e8590c;
            --bs-primary-rgb: 253, 126, 20;
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-danger: #dc3545;
            --bs-warning: #ffc107;
            --bs-info: #0dcaf0;
        }

        [data-bs-theme="dark"] {
            --bs-primary: #fd7e14;
            --bs-primary-hover: #ff8c42;
            --bs-body-bg: #1a1a1a;
            --bs-body-color: #e9ecef;
            --bs-border-color: #495057;
        }

        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-primary:hover {
            background-color: var(--bs-primary-hover);
            border-color: var(--bs-primary-hover);
        }

        .navbar-brand {
            font-weight: 600;
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            background-color: var(--bs-primary);
            color: white;
            border-bottom: none;
        }

        .form-control:focus {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(253, 126, 20, 0.05);
        }

        .alert {
            border: none;
            border-radius: 0.5rem;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bs-primary) 0%, #ff8c42 100%);
        }

        .login-card {
            border-radius: 1rem;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--bs-success);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background-color: var(--bs-danger);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: var(--bs-gray-100);
            border-right: 1px solid var(--bs-border-color);
        }

        .navbar {
            height: 60px;
            padding: 0.5rem 0;
        }
        
        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 0.25rem 0;
            border-top: 1px solid var(--bs-border-color);
            background: var(--bs-body-bg);
        }
        
        .nav-links .nav-link {
            color: var(--bs-body-color);
            text-decoration: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .nav-links .nav-link:hover {
            background: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--bs-primary);
        }
        
        .nav-links .nav-link.active {
            background: var(--bs-primary);
            color: white;
        }
        
        .main-content {
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        .setting-card {
            transition: transform 0.2s;
        }

        .setting-card:hover {
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-avatar:hover {
            background-color: #f8f9fa;
            border-color: var(--bs-primary);
            transform: scale(1.05);
        }
        
        .user-dropdown {
            position: relative;
        }
        
        .user-dropdown .dropdown-toggle {
            background: none;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-dropdown .dropdown-toggle::after {
            display: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if session.user_id %}
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--bs-primary);">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-shield-check me-2"></i>FakeICAP
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- Navigation removed - only theme toggle and user menu remain -->
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item user-dropdown">
                        <button class="nav-link dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <div class="user-avatar">{{ session.username[0].upper() }}</div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">{{ session.username }}</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('change_password') }}">
                                <i class="bi bi-key me-2"></i>Change Password
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

        <!-- Main Content -->
    {% if 'user_id' in session %}
    {% set role = session.get('role') or 'FULL_ACCESS' %}
    {% set is_admin = session.get('is_admin') %}
    <!-- Navigation Links -->
    <div class="nav-links">
        <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
            <i class="bi bi-speedometer2 me-1"></i>Dashboard
        </a>
        {% if is_admin or role in ['FULL_ACCESS', 'LOG_VIEWER'] %}
        <a class="nav-link {% if request.endpoint == 'logs' %}active{% endif %}" href="{{ url_for('logs') }}">
            <i class="bi bi-file-text me-1"></i>Logs
        </a>
        {% endif %}
        {% if is_admin or role in ['FULL_ACCESS', 'FILE_DOWNLOAD'] %}
        <a class="nav-link {% if request.endpoint == 'processed_files' %}active{% endif %}" href="{{ url_for('processed_files') }}">
            <i class="bi bi-folder me-1"></i>Files
        </a>
        {% endif %}
        {% if session.get('is_admin') %}
        <a class="nav-link {% if request.endpoint == 'settings_page' %}active{% endif %}" href="{{ url_for('settings_page') }}">
            <i class="bi bi-gear me-1"></i>Settings
        </a>
        <a class="nav-link {% if request.endpoint == 'users' %}active{% endif %}" href="{{ url_for('users') }}">
            <i class="bi bi-people me-1"></i>Users
        </a>
        {% endif %}
        <a class="nav-link {% if request.endpoint == 'change_password' %}active{% endif %}" href="{{ url_for('change_password') }}">
            <i class="bi bi-person me-1"></i>Account
        </a>
    </div>
    {% endif %}
    
    <div class="container-fluid">
        <div class="row">
            <!-- Content Area -->
            <div class="col-12 main-content">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Login/Register Layout -->
    {% block auth_content %}{% endblock %}
    {% endif %}

    <!-- Flash Messages - Convert to Slide-out Notifications -->
    <div id="flash-messages" style="display: none;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message" data-category="{{ category }}" data-message="{{ message | e }}"></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Convert Flask flash messages to slide-out notifications
        const flashMessages = document.querySelectorAll('.flash-message');
        
        flashMessages.forEach(function(flashElement) {
            const category = flashElement.getAttribute('data-category');
            const message = flashElement.getAttribute('data-message');
            
            // Convert Bootstrap categories to notification types
            const typeMap = {
                'error': 'error',
                'warning': 'warning', 
                'success': 'success',
                'info': 'info',
                'message': 'info'
            };
            
            const notificationType = typeMap[category] || 'info';
            
            // Show as slide-out notification after a short delay
            setTimeout(() => {
                if (window.notificationManager) {
                    window.notificationManager.show(message, notificationType);
                } else {
                    console.log(`[${category.toUpperCase()}] ${message}`);
                }
            }, 500);
        });
    });
    </script>

    <!-- Theme Toggle -->
    <button class="btn btn-primary theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Theme management
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        const icon = document.getElementById('theme-icon');
        
        html.setAttribute('data-bs-theme', newTheme);
        icon.className = newTheme === 'light' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
        
        // Theme toggle only affects the current session; global default comes from Settings.
    }

    // Initialize theme and accent color from global settings
    document.addEventListener('DOMContentLoaded', function() {
        const html = document.documentElement;
        const serverTheme = html.getAttribute('data-bs-theme') || 'light';
        html.setAttribute('data-bs-theme', serverTheme);

        const icon = document.getElementById('theme-icon');
        if (icon) {
            icon.className = serverTheme === 'light' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
        }
        
        // Apply accent color from global settings
        const serverAccentColor = '{{ ui_accent_color|default("orange") }}';
        applyAccentColor(serverAccentColor || 'orange');
    });

    // Dynamic accent color management
    window.applyAccentColor = function(color) {
        const root = document.documentElement;
        
        const colorMap = {
            'orange': {
                primary: '#fd7e14',
                hover: '#e8590c',
                rgb: '253, 126, 20'
            },
            'blue': {
                primary: '#0d6efd',
                hover: '#0b5ed7',
                rgb: '13, 110, 253'
            },
            'green': {
                primary: '#198754',
                hover: '#157347',
                rgb: '25, 135, 84'
            },
            'purple': {
                primary: '#6f42c1',
                hover: '#5c37a6',
                rgb: '111, 66, 193'
            },
            'red': {
                primary: '#dc3545',
                hover: '#bb2d3b',
                rgb: '220, 53, 69'
            }
        };
        
        const colors = colorMap[color] || colorMap['orange'];
        
        // Update CSS variables
        root.style.setProperty('--bs-primary', colors.primary);
        root.style.setProperty('--bs-primary-hover', colors.hover);
        root.style.setProperty('--bs-primary-rgb', colors.rgb);
        
        // Update dark theme variables
        const darkTheme = root.querySelector('[data-bs-theme="dark"]') || root;
        darkTheme.style.setProperty('--bs-primary', colors.primary);
        darkTheme.style.setProperty('--bs-primary-hover', colors.hover);
        
        // Update focus shadow with new color
        const style = document.createElement('style');
        style.textContent = `
            .form-control:focus {
                border-color: ${colors.primary} !important;
                box-shadow: 0 0 0 0.2rem rgba(${colors.rgb}, 0.25) !important;
            }
            .table-hover tbody tr:hover {
                background-color: rgba(${colors.rgb}, 0.05) !important;
            }
            .login-container {
                background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.hover} 100%) !important;
            }
        `;
        
        // Remove old accent color style if exists
        const oldStyle = document.getElementById('accent-color-style');
        if (oldStyle) {
            oldStyle.remove();
        }
        
        style.id = 'accent-color-style';
        document.head.appendChild(style);
        
        // Save to localStorage
        localStorage.setItem('accentColor', color);
    }

    // Auto-hide flash messages
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- Custom Notification System -->
    {% include 'notifications.html' %}

    <script>
    // Override Flask flash messages to use custom notifications
    document.addEventListener('DOMContentLoaded', function() {
        // Override Flask flash messages
        const originalFlash = window.flash;
        window.flash = function(message, category) {
            // Convert Bootstrap categories to notification types
            const typeMap = {
                'error': 'error',
                'warning': 'warning', 
                'success': 'success',
                'info': 'info',
                'message': 'info'
            };
            
            const notificationType = typeMap[category] || 'info';
            
            // Use custom notification manager if available
            if (window.notificationManager) {
                window.notificationManager.show(message, notificationType);
            } else {
                // Fallback to alert
                console.log(`[${category.toUpperCase()}] ${message}`);
            }
        };
        
        // Override Bootstrap alerts
        if (window.bootstrap && window.bootstrap.Alert) {
            const originalAlert = window.bootstrap.Alert.prototype.constructor;
            window.bootstrap.Alert.prototype.constructor = function(element, options) {
                originalAlert.call(this, element, options);
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    this.close();
                }, 3000);
            };
        }
    });
    </script>
